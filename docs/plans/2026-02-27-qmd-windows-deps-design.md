# Дизайн: Автоматическая установка зависимостей QMD на Windows

**Дата:** 2026-02-27
**Статус:** Утверждён

---

## Проблема

При установке QMD (`npm install -g @tobilu/qmd`) на Windows возникает ошибки:
- `gyp ERR!` — не хватает Visual Studio Build Tools
- `MSBuild / .vcxproj` — не хватает Visual Studio components
- `Can't find Python executable` — не установлен Python для node-gyp

Текущий скрипт `install-tools.sh` проверяет только Node.js, но не зависимости для сборки нативных модулей.

---

## Решение

Добавить автоматическую проверку и установку зависимостей через winget с UAC prompt.

---

## Философия

**Бесшовность и автоматизация.** Пользователь только отвечает на вопросы интервью, а дальше всё происходит автоматически. Минимальные усилия пользователя.

---

## Компоненты для установки

| Компонент | Назначение |
|-----------|------------|
| Python 3.x | Для node-gyp |
| Visual Studio Build Tools (C++ workload) | Компиляция нативных модулей |
| Node.js LTS | Если не установлен |

---

## Архитектура

### Подход: PowerShell-модуль внутри install-vault.md

Всё встраивается в существующий flow `/install-vault`:
- Новый шаг 10.5 перед настройкой QMD
- PowerShell-функции для проверки и установки
- UAC prompt через `Start-Process -Verb RunAs`
- Fallback на инструкции при ошибках

### Структура PowerShell-логики

```powershell
function Test-Dependencies {
    # Проверяет Node.js, Python, VS Build Tools
    # Возвращает $true если всё установлено
}

function Install-MissingDependencies {
    # 1. Проверяет winget
    # 2. Формирует список недостающих компонентов
    # 3. Запускает установку через UAC
    # 4. Ждёт завершения
}

function Get-ManualInstructions {
    # Возвращает markdown с ссылками для ручной установки
}
```

### Поток выполнения

```
Test-Dependencies()
    │
    ├─ всё ок → переход к установке QMD
    │
    └─ не хватает компонентов
           │
           ├─ winget доступен → Install-MissingDependencies() с UAC
           │
           └─ winget недоступен → Get-ManualInstructions()
```

---

## Обработка ошибок

| Ситуация | Действие |
|----------|----------|
| UAC отклонён | Инструкции, продолжить без QMD |
| winget недоступен | Инструкции с прямыми ссылками |
| Установка failed | Ошибка, инструкции, продолжить без QMD |
| Таймаут (5 мин) | Предложить пропустить |
| Не Windows | Пропустить, использовать текущую логику |

**После ошибок:** setup продолжается, в отчёте указать статус QMD.

---

## Изменения в файлах

### Изменить: `.claude/commands/install-vault.md`

1. Добавить **Шаг 10.5: Проверка зависимостей для QMD**
2. Обновить **Шаг 11 (QMD)** — использовать новую логику
3. Обновить **финальный отчёт** — показывать статус QMD

### Изменить: `.claude/docs/install-guide.md`

1. Добавить секцию "Требования для Windows"
2. Обновить troubleshooting

### Новые файлы

Не требуются.

---

## Критерии успеха

1. Пользователь на Windows 10/11 с winget получает автоматическую установку всех зависимостей
2. При отказе UAC или ошибках — понятные инструкции
3. Setup продолжается независимо от успеха установки QMD
4. На Mac/Linux поведение не меняется
